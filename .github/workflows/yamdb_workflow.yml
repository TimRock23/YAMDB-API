name: yamdb-api workflow


on: [push]


jobs:
  deploy:
    env:
      PROJECT_ROOT: ~/yamdb_final
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub

    steps:
      - name: executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: "docker-compose.yaml, nginx/default.conf, static, media"
          target: ${{ env.PROJECT_ROOT}}
          script: |
            cd ${{ env.PROJECT_ROOT }}
            sudo apt install docker.io -y
            sudo curl -L "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo docker pull timrock/yamdb_final
            sudo docker-compose stop
            sudo docker-compose rm web
            sudo docker-compose up

  send_message:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: send_message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: ${{ github.workflow }} успешно выполнен!
